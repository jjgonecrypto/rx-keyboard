<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rx Keyboard</title>
  <script src="./node_modules/rx/dist/rx.lite.js"></script>
  <script src="./node_modules/soundfont-player/dist/soundfont-player.js"></script>
  <script src="./build/teoria.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
        'use strict';

        var ctx = new AudioContext();

        var teoria = require('teoria');
        // window.Rx
        var soundfont = new Soundfont(ctx);

        function createLoopScale(fromNote, name) {
            var notesUp = teoria.note(fromNote).scale(name).notes();
            return notesUp.concat([teoria.note(fromNote).interval('P8')]).concat(notesUp.reverse());
        }

        // load instrument
        var instrument = soundfont.instrument('acoustic_grand_piano');
        soundfont.onready(function() {
            var notes = createLoopScale('c3', 'major');

            // step 1 : simple spread over 300ms intervals
            // var score = Rx.Observable.interval(300).map(function (i) { return notes[i]; }).take(notes.length);

            // step 2: merge two streams
            // var mode = createLoopScale('f3', 'lydian');
            // var streamA = Rx.Observable.interval(300).map(function (i) { return notes[i]; });
            // var streamB = Rx.Observable.interval(300).map(function (i) { return mode[i]; }).delay(100);
            // var score = streamA.merge(streamB).take(notes.length * 2);

            // step 3: create a stream (chords) from another
            var score = Rx.Observable.interval(300).map(function (i) { return notes[i]; }).selectMany(function (x, i) {
                return [x, teoria.note(x.interval('M3').toString()), teoria.note(x.interval('P5').toString())];
            }).take(notes.length * 3);

            score.subscribe(function onNext(note) {
                console.log(note.toString());
                instrument.play(note.toString(), ctx.currentTime, 250);
            }, function onError() {
                console.log('error');
            }, function onComplete() {
                console.log('complete');
            });

        });
    });
  </script>
  <style>

  </style>
</head>
<body>

</body>
</html>
